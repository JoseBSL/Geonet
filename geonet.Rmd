---
title: "Geonet"
author: "Liam Kendall"
date: "23 August 2018"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
##libraries
library(gridExtra)
library(dplyr)
library(reshape2)
library(vegan)
library(kgc)
library(tidyverse)
library(reshape)
library(taxize)
library(plyr)
library(dplyr)
library(stringi)
library(stringr)
library(tidyr)
library(glmmTMB)

##Reference dataframe
reference=read.csv("data/ref/references.csv",header=T)
colnames(reference)[1]="Network"

left = function (string,char){
  substr(string,1,char)
}
reference$ID=left(reference$Network,8)
reference=reference[!duplicated(reference$ID),]
reference$Network=reference$ID

##Add climate zone
climate_zone=reference[,c("ID","Longitude","Latitude")]
climate_zone <- data.frame(climate_zone,
                   rndCoord.lon = RoundCoordinates(climate_zone$Longitude),
                   rndCoord.lat = RoundCoordinates(climate_zone$Latitude))
reference <- data.frame(reference,ClimateZ=LookupCZ(climate_zone))
reference$ClimateZ=as.character(reference$ClimateZ)
reference[26,c("ClimateZ")]=c("BWh")
reference[60,c("ClimateZ")]=c("Af")
reference$clim=left(reference$ClimateZ,1)


#Elevation
##ELEVATION DATA
require(geonames)
require(MuMIn)

#Two methods
options(geonamesUsername="liamkendall")

ele2=by(reference, 1:nrow(reference), function(x) GNsrtm3(lat=x$Latitude,lng=x$Longitude))
ele2=do.call("rbind", ele2)

reference$ele=ele2$srtm3

#http://www.gpsvisualizer.com/elevation
reference[reference$ele<0,]
reference[reference$ID %in% "M_PL_009",c("ele")] = 1009
reference[reference$ID %in% "M_PL_010",c("ele")] =  261
reference[reference$ID %in% "M_PL_014",c("ele")] = 250
reference[reference$ID %in% "M_PL_020",c("ele")] = 250
reference[reference$ID %in% "M_PL_024",c("ele")] = 92 
reference[reference$ID %in% "M_PL_026",c("ele")] = 1 #iffy
reference[reference$ID %in% "M_PL_045",c("ele")] = 1 #iffy
reference[reference$ID %in% "M_PL_052",c("ele")] = 139 
reference[reference$ID %in% "M_PL_060",c("ele")] = 1 #iffy



##read in plant families from taxize

plant_family=read.csv("data/processing/plant_family.csv")
plant_order=read.csv("data/processing/plant_order.csv")
plant_family=merge(plant_order,plant_family,by="family")

#all networks into list
setwd("~/Dropbox/PhD/Rprojects/Geonet/data")
files = list.files(pattern="*.csv")
myfiles = lapply(files, function(x) read.csv(x, stringsAsFactors = FALSE, sep=","))
setwd("~/Dropbox/PhD/Rprojects/Geonet")

#NAme list objects/networks
names(myfiles)=left(files,8)
names(myfiles)

#Melt
myfiles.melt=melt(myfiles,id.vars=c(1))

#Aggregate - merges 
myfiles.melt.agg=aggregate(value ~ X + variable+L1,data=myfiles.melt, FUN=sum)
myfiles.melt.agg$value=ifelse(myfiles.melt.agg$value > 0, 1, 0)
colnames(myfiles.melt.agg)=c("Plant","Pollinator","Network","Int")

myfiles.melt.agg.z=myfiles.melt.agg[!myfiles.melt.agg$Int==0,]
myfiles.melt.agg.z$Pollinator=gsub("\\."," ",myfiles.melt.agg.z$Pollinator)


poll_famord_5=read.csv("data/processing/poll_famord_5.csv",header=T)

### Plant / Pollinator genera columns
myfiles.melt.agg.z$PGenus=word(myfiles.melt.agg.z$Plant,1)
myfiles.melt.agg.z$IGenus=word(myfiles.melt.agg.z$Pollinator,1)

#Remove plants from bird networks - plant_family was made with these networks
minus_plant=setdiff(plant_family$PGenus,myfiles.melt.agg.z$PGenus)

#remove plant families from bird networks
custom.subset <- function(df, keywords) {
  y <- df[apply(df, 1, function(x) all(!x %in% keywords)),]
  return(y)
}

plant_family_subset=custom.subset(plant_family, minus_plant)

#add plant families
str(myfiles.melt.agg.z)
str(plant_family_subset)
myfiles.melt.agg.z <- myfiles.melt.agg.z %>% mutate_if(is.character,as.factor)
geonet=merge(myfiles.melt.agg.z,plant_family_subset[,c("PGenus","family","order")], by = "PGenus")
str(reference)
str(geonet)
colnames(geonet)[7:8]=c("Pfamily","Porder")
geonet=merge(geonet,reference[,c("ele","clim","Network","Connectance","Latitude","Longitude")], by = "Network")

#add pollinator families
str(poll_famord_5)
str(geonet)
geonet=merge(geonet,poll_famord_5[,c("IGenus","Order","Family")], by = "IGenus")
colnames(geonet)[14:15]=c("PolOrder","PolFamily")
geonet <- geonet %>% mutate_if(is.factor,as.character)
geonet[geonet$PolFamily%in%c("Stenotritidae","Apidae","Andrenidae","Colletidae","Megachilidae","Melittidae","Halictidae"),c("PolOrder")]="Bee"
geonet[geonet$PolFamily%in%c("Syrphidae"),c("PolOrder")]="Syrphidae"

geonet <- geonet %>% mutate_if(is.character,as.factor)

g=geonet%>%
group_by(Network, PolOrder) %>%
  summarise(order_links=sum(Int))

g2=g%>%
  group_by(Network) %>%
  summarise(int_tot=sum(order_links))

g3=merge(g,g2)

g3$prop_links=g3$order_links/g3$int_tot

g4=merge(g3,reference,by="Network")

#subset data by insect order
g.sub <- subset(g4, Order %in% c("Hymenoptera", "Bee","Diptera", "Lepidoptera","Syrphidae","Coleoptera"))

str(g.sub)
range(g.sub$prop_links)

```


```{r cars}
summary(cars)
```


```{r pressure, echo=FALSE}
plot(pressure)
```
